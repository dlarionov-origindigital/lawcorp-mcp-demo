# 7.5.3: Manual end-to-end authorization verification

**Status:** BACKLOG
**Type:** Story
**Feature:** [7.5: Supplemental E2E Tests](./7.5-supplemental-e2e-tests.md)
**Tags:** `+testing` `+auth` `+e2e`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)
**Runbook:** [`docs/local-mcp-inspect-auth.md`](../../../docs/local-mcp-inspect-auth.md)

---

As a developer validating the identity passthrough architecture,
I want a repeatable manual test procedure using real Entra ID tokens and the MCP Inspector,
So that I can confirm end-to-end that two personas with different roles produce different tool results through the same MCP server.

## Context

Automated tests (7.3.1–7.3.4) use `FakeIdentityContext` and mock Graph endpoints to verify authorization logic without real Entra tokens. This story provides the complementary **real-infra verification**: actual Azure AD users, actual JWT Bearer tokens, actual OBO exchange, and the actual MCP Inspector UI.

The test protocol is simple: log in as Persona A, invoke a tool, record the result. Log in as Persona B, invoke the same tool, confirm the result is different. If both personas see the same data, identity passthrough is broken.

## Prerequisites

- Azure app registration completed ([docs/auth-config.md](../../../docs/auth-config.md))
- Six persona users created in the tenant with app roles assigned
- Persona seed data populated with correct OIDs ([Personas/README.md](../../../src/LawCorp.Mcp.MockData/Personas/README.md))
- MCP server running with HTTP transport and `UseAuth=true`

## Test Protocol

### Round 1: Partner vs. Associate (Harvey vs. Kim)

| Step | Action | Expected |
|---|---|---|
| 1 | Acquire token for Harvey Specter (Partner) | Token has `oid` matching Harvey's `EntraObjectId`, `roles: ["Partner"]` |
| 2 | Connect MCP Inspector with Harvey's token | Connection succeeds, tools listed |
| 3 | Invoke `cases_search` with `{"query": "merger"}` | Returns all M&A practice group cases |
| 4 | Record case count and IDs | — |
| 5 | Disconnect Inspector | — |
| 6 | Acquire token for Kim Wexler (Associate) | Token has `oid` matching Kim's `EntraObjectId`, `roles: ["Associate"]` |
| 7 | Connect MCP Inspector with Kim's token | Connection succeeds |
| 8 | Invoke `cases_search` with `{"query": "merger"}` | Returns **only cases Kim is assigned to** |
| 9 | Compare case count with Step 4 | Kim sees fewer cases than Harvey |

**Pass criteria:** Kim's result set is a strict subset of Harvey's.

### Round 2: Partner vs. Intern (Harvey vs. Vinny)

| Step | Action | Expected |
|---|---|---|
| 1 | Connect as Harvey, read a privileged document | Full document content returned |
| 2 | Connect as Vinny, read the same document | Document returned with **redacted privileged content** |

**Pass criteria:** Same document ID, different content. Vinny's version has redacted fields.

### Round 3: Consent boundary

| Step | Action | Expected |
|---|---|---|
| 1 | Connect as any persona | Connection succeeds |
| 2 | Invoke a Graph-backed tool (e.g. calendar access) | If consent is granted: data returned. If not: structured MCP error with consent URL |

**Pass criteria:** Missing consent produces a structured error, not an unhandled 500.

## Acceptance Criteria

- [ ] Round 1 (Partner vs. Associate) passes — different case sets returned
- [ ] Round 2 (Partner vs. Intern) passes — same document, different content
- [ ] Round 3 (Consent boundary) passes — structured error on missing consent
- [ ] All six personas produce non-empty, correctly-scoped results for at least one tool
- [ ] The runbook ([docs/local-mcp-inspect-auth.md](../../../docs/local-mcp-inspect-auth.md)) is accurate and followable by a developer unfamiliar with the project
- [ ] Token acquisition works via at least one documented method (az CLI, ROPC, or device code)

## Dependencies

- 1.2.4 (downstream resource access) — auth infrastructure in place
- HTTP transport enabled (`ModelContextProtocol.AspNetCore` + `WebApplication`)
- MCP Inspector v0.17.0+ (Bearer token forwarding fix)
- At least one tool that queries the database with identity-scoped results

## Notes

This is a **manual verification** story, not automated. It complements the automated tests in 7.3.4 (which use `FakeIdentityContext`). The two approaches validate different things:

| Aspect | 7.3.4 (automated) | 7.5.3 (manual) |
|---|---|---|
| Identity source | `FakeIdentityContext` | Real Entra ID JWT |
| Graph calls | Mock HTTP handler | Real Graph API (if consent granted) |
| DB access | SQLite in-memory | Local SQL Express |
| Token exchange | Mocked | Real OBO via MSAL |
| CI-friendly | Yes | No (requires Azure tenant) |
| Catches | Logic bugs in auth handlers | Config bugs in app registration, middleware ordering, claim mapping |

Both are needed. Automated tests catch regressions in CI; manual E2E catches configuration and infrastructure issues.
