# 7.1.1: DB provider adapter

**Status:** BACKLOG
**Type:** Task
**Feature:** [7.1: Test Infrastructure](./7.1-test-infrastructure.md)
**Tags:** `+testing` `+infrastructure`

---

Implement a DB provider adapter so that tests can run against SQLite in-memory (fast, CI-safe) while the same test code can be pointed at LocalDB or Azure SQL for environmental parity testing, controlled by configuration rather than code changes.

## Implementation Steps

- [ ] Define an `IDbProviderAdapter` interface (or convention) in `LawCorp.Mcp.Tests` that wraps EF Core provider registration
- [ ] Implement `SqliteInMemoryAdapter` — uses `Microsoft.EntityFrameworkCore.Sqlite` with a named in-memory connection so the same connection is shared within a test's lifetime
- [ ] Implement `SqlServerAdapter` — uses `Microsoft.EntityFrameworkCore.SqlServer` with a connection string from `appsettings.Test.json` or environment variables; used for `[Trait("Category","E2E")]` tests only
- [ ] Register the correct adapter in `LawCorpWebApplicationFactory` based on `TestDb:Provider` config value (`sqlite-memory` | `sqlserver`)
- [ ] Ensure EF Core schema is created via `EnsureCreated()` (not migrations) for in-memory runs so tests are self-contained
- [ ] Document the adapter pattern in a code comment so future contributors understand how to add a new provider

## Acceptance Criteria

- [ ] `TestDb:Provider=sqlite-memory` creates and migrates an in-memory DB per test class
- [ ] `TestDb:Provider=sqlserver` connects to a real SQL Server instance (skipped if connection string absent)
- [ ] No test fails due to SQLite incompatibility with the EF Core model (validate global query filters, value converters, and JSON columns work under SQLite)
- [ ] The adapter can be swapped without modifying any test class

## Notes

SQLite does not support all SQL Server features (e.g., `CONTAINS`, certain date functions). If the production queries use SQL Server-specific functions, the in-memory tests must use a fake or stub at the service layer, or those tests must be marked `[Trait("Category","E2E")]` and run against SQL Server only.
