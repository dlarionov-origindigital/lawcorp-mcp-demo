# 7.3.4: Identity passthrough authorization tests

**Status:** BACKLOG
**Type:** Story
**Feature:** [7.3: Authorization Scenario Tests](./7.3-authorization-tests.md)
**Tags:** `+testing` `+auth`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)

---

As a developer verifying the identity passthrough architecture,
I want a dedicated test suite that proves each persona's identity flows through to every downstream resource type,
So that I can confirm the core value proposition — "only see what you're authorized to see" — holds across Graph resources and local database access.

## Context

Stories 7.3.1–7.3.3 test role-based access, row-level security, and field redaction against the local database. This story extends authorization testing to cover the identity passthrough pattern end-to-end, including:

1. **Graph-backed resources** — tools that call Microsoft Graph via OBO must respect per-user permissions
2. **Mixed-source tools** — tools that combine local DB data with Graph data must enforce both authorization layers
3. **Consent boundary** — tools requiring ungranted Graph scopes must return structured consent errors, not data

## Test Scenarios

### Graph access via OBO (mock Graph endpoint)

| # | Scenario | Persona | Expected Result |
|---|---|---|---|
| 1 | Read own Outlook calendar events | Harvey Specter | 200, events returned |
| 2 | Read own Outlook calendar events | Vinny Gambini | 200, own schedule only (no other users' events) |
| 3 | Read assigned attorney's calendar | Elle Woods | 200, Harvey's calendar events returned |
| 4 | Read unrelated attorney's calendar | Kim Wexler | 403 or empty result (Kim is not Elle's assigned attorney) |
| 5 | Access SharePoint site with permission | Harvey Specter | 200, documents listed |
| 6 | Access SharePoint site without permission | Vinny Gambini | Structured permission-denied error |

### Local database via IFirmIdentityContext

| # | Scenario | Persona | Expected Result |
|---|---|---|---|
| 7 | Search cases — Partner | Harvey Specter | Cases Alpha + Beta returned (M&A practice group) |
| 8 | Search cases — Associate | Kim Wexler | Case Alpha only (assigned case) |
| 9 | Search cases — OfCounsel cross-practice | Alan Shore | Case Gamma only (Securities practice group) |
| 10 | Read privileged document — Intern | Vinny Gambini | Document returned with redacted content |
| 11 | Access billing — Paralegal | Erin Brockovich | 403 or empty (no billing access per PRD 4.2) |

### Consent boundary

| # | Scenario | Persona | Expected Result |
|---|---|---|---|
| 12 | Graph tool call with missing consent | Any persona | Structured consent-required error with scopes listed |
| 13 | Retry after consent granted | Any persona | Tool call succeeds |

## Implementation Steps

- [ ] Set up a mock Graph HTTP endpoint (via `HttpMessageHandler` or WireMock) that the `GraphServiceClient` calls in integration tests, returning persona-appropriate responses
- [ ] Create parameterized test class `IdentityPassthroughTests` that accepts `FirmPersona` and runs each scenario above
- [ ] For Graph scenarios: configure mock to return 200 for authorized personas and 403 for unauthorized ones, verifying the MCP tool handler translates these correctly
- [ ] For DB scenarios: reuse `FakeIdentityContext` and `PersonaFixtureSeeder` — assert correct filtering per persona
- [ ] For consent scenarios: configure mock OBO provider to throw `ConsentRequiredException`, verify MCP error response structure

## Acceptance Criteria

- [ ] All 13 scenarios above pass
- [ ] Tests use `FakeIdentityContext` — no real Entra tokens required
- [ ] Graph-calling tests use a mock HTTP handler — no real Graph calls
- [ ] Each test clearly documents which ADR-005 access pattern it validates (Graph OBO vs. local DB)
- [ ] Tests are parameterized by persona where applicable

## Dependencies

- 7.1 (test infrastructure) — `WebApplicationFactory`, `FakeIdentityContext`
- 7.2 (persona fixture) — seeded test data
- 1.2.4 (downstream resource access) — the services being tested
- 1.3 (authorization layer) — auth handlers for DB scenarios
