# 7.1.2: `IFirmIdentityContext` test double

**Status:** BACKLOG
**Type:** Task
**Feature:** [7.1: Test Infrastructure](./7.1-test-infrastructure.md)
**Tags:** `+testing` `+auth` `+infrastructure`

---

Implement `FakeIdentityContext`, a test double for `IFirmIdentityContext` (defined in story 1.3.5), that allows tests to impersonate any of the six firm personas without requiring a real Entra ID token or hitting the authentication middleware.

## Implementation Steps

- [ ] Implement `FakeIdentityContext : IFirmIdentityContext` in `LawCorp.Mcp.Tests`
- [ ] `FakeIdentityContext` accepts a `FirmPersona` enum value (one per persona) and exposes the correct `UserId`, `UserRole`, `PracticeGroupId`, `AssignedAttorneyId`, and claim set that the authorization handlers expect
- [ ] Implement `FirmPersona` enum: `HarveySpecter` (Partner), `KimWexler` (Associate), `AlanShore` (OfCounsel), `ErinBrockovich` (Paralegal), `ElleWoods` (LegalAssistant), `VinnyGambini` (Intern)
- [ ] The enum values must map to the stable IDs emitted by `PersonaFixtureSeeder` (see 7.2.2) so that row-level filters resolve correctly
- [ ] In `LawCorpWebApplicationFactory`, override the DI registration to substitute `FakeIdentityContext` for `IFirmIdentityContext` when `TestAuth:UseFakeIdentity=true`
- [ ] Expose a `WithPersona(FirmPersona)` extension method on `HttpClient` (or equivalent) that sets the current persona for a single request (for per-request persona switching in the same test)

## Acceptance Criteria

- [ ] Tests can impersonate any persona by passing a `FirmPersona` enum value â€” no tokens, no Entra ID calls
- [ ] Switching personas mid-test (if needed) does not affect other parallel tests
- [ ] The `FakeIdentityContext` correctly reflects the practice group and assignment data from the persona fixture
- [ ] Authorization handlers receive the same claim shape from `FakeIdentityContext` as they would from a real Entra ID token

## Notes

Depends on [1.3.5](../01-foundation/1.3.5-firm-identity-context.md) for the `IFirmIdentityContext` interface.
The stable IDs used here must be kept in sync with [7.2.1](./7.2.1-persona-catalog.md) (persona catalog) and [7.2.2](./7.2.2-fixture-data-seeder.md) (fixture seeder).
