# 7.1.3: Web API test host (`WebApplicationFactory`)

**Status:** BACKLOG
**Type:** Task
**Feature:** [7.1: Test Infrastructure](./7.1-test-infrastructure.md)
**Tags:** `+testing` `+infrastructure`

---

Implement `LawCorpWebApplicationFactory`, a shared `WebApplicationFactory<Program>` subclass that boots the server in `http` mode against the in-memory SQLite DB with `FakeIdentityContext` substituted for the real identity middleware. This is the base class for all integration and E2E test classes.

## Implementation Steps

- [ ] Verify that `WebApplicationFactory<Program>` works with the MCP SDK's `IHostedService` registration. If the SDK's HTTP transport requires a running Kestrel instance, configure the factory to use `TestServer` instead and document any limitations.
- [ ] Create `LawCorpWebApplicationFactory : WebApplicationFactory<Program>` in a `LawCorp.Mcp.Tests/Infrastructure/` folder
- [ ] Override `ConfigureWebHost` to:
  - Set `Transport:Mode=http` (override appsettings so the server doesn't try to start stdio)
  - Set `TestDb:Provider=sqlite-memory`
  - Set `TestAuth:UseFakeIdentity=true`
  - Replace `IFirmIdentityContext` registration with `FakeIdentityContext`
  - Replace the EF Core provider registration via the DB adapter
- [ ] Expose a `CreateAuthenticatedClient(FirmPersona persona)` method that returns an `HttpClient` pre-configured to use the given persona's identity
- [ ] Implement a `IClassFixture<LawCorpWebApplicationFactory>` usage pattern so the factory is created once per test class (not per test method) to avoid startup overhead
- [ ] Seed the `PersonaFixture` dataset before the first test runs; reset between test classes if mutation tests are included

## Acceptance Criteria

- [ ] `LawCorpWebApplicationFactory` starts in < 2 seconds in CI
- [ ] `CreateAuthenticatedClient(FirmPersona.HarveySpecter)` returns a client whose requests are evaluated as Harvey Specter (Partner)
- [ ] The server's MCP tool endpoints are reachable at their expected HTTP paths via the test client
- [ ] Fixture data is present and consistent across all tests within a class

## Notes

See [ADR-004](../../decisions/004-dual-transport-web-api-primary.md) for the rationale behind Web API as the primary test surface.
Check the MCP SDK changelog for `WithHttpTransport()` / `WithStreamableHttpTransport()` support before implementing â€” the transport registration differs from `WithStdioServerTransport()`.
