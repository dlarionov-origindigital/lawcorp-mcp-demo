# Bug Research: Sign-In Issues

**Related bug report:** [8.1.2.2-sign-in_bug.md](./8.1.2.2-sign-in_bug.md)
**Bugs found:** 2

---

## Bug A: AuthenticationFailureException: Correlation Failed

### Symptom

First sign-in attempt throws `AuthenticationFailureException: Correlation failed`. Reloading and trying again succeeds.

### Root Cause (Primary): Blazor Enhanced Navigation Intercepts the OIDC Redirect

In .NET 8/9, Blazor's enhanced navigation (`blazor.web.js`) intercepts all `<a href>` clicks by default and turns them into `fetch()` requests instead of true browser navigations. This is what makes OIDC intermittently fail:

1. User clicks Sign In → Blazor intercepts, fires `fetch()` to `/MicrosoftIdentity/Account/SignIn`
2. OIDC middleware sets a **correlation cookie** and returns a `302` to `login.microsoftonline.com`
3. The `fetch()` follows the cross-site redirect — CORS prevents the cookie from being set correctly
4. User authenticates on Entra ID, is redirected back to `/signin-oidc`
5. OIDC middleware looks for the correlation cookie — it's missing → **"Correlation failed"**

On reload, the browser performs a true top-level navigation (no Blazor interception), the cookie is set and sent correctly, and sign-in succeeds. This explains the exact symptom: fails first attempt, works on retry.

This is a documented, known issue. Microsoft's own `BlazorWebAppOidc` sample template explicitly adds `data-enhance-nav="false"` to all authentication links for exactly this reason.

**Files affected:**
- [LoginDisplay.razor](../../../src/LawCorp.Mcp.Web/Components/Layout/LoginDisplay.razor) — lines 22 and 28

**Fix:**
Add `data-enhance-nav="false"` to both the sign-in and sign-out anchors:

```razor
@* Sign in link (line 28) *@
<a href="MicrosoftIdentity/Account/SignIn" data-enhance-nav="false" style="text-decoration: none;">

@* Sign out link (line 22) *@
<a href="MicrosoftIdentity/Account/SignOut" data-enhance-nav="false" style="margin-left: 12px; text-decoration: none;">
```

---

### Root Cause (Secondary): `UseAntiforgery()` Placed Before `UseAuthentication()`

Current middleware order in [Program.cs](../../../src/LawCorp.Mcp.Web/Program.cs):

```csharp
app.UseHttpsRedirection();
app.UseAntiforgery();       // ← runs BEFORE authentication

if (useAuth)
{
    app.UseAuthentication();
    app.UseAuthorization();
    app.MapControllers();
}
```

The documented correct order for Blazor + OIDC is:

```
UseAuthentication → UseAuthorization → UseAntiforgery → MapControllers → MapRazorComponents
```

The `/signin-oidc` callback is a POST from Entra ID. When `UseAntiforgery()` runs first, it can examine or interfere with this request before `UseAuthentication()` processes the OIDC state. This is a secondary cause that compounds the enhanced navigation issue and violates the documented middleware ordering requirements for ASP.NET Core 8/9.

**Files affected:**
- [Program.cs](../../../src/LawCorp.Mcp.Web/Program.cs) — line 43

**Fix:**
Move `UseAntiforgery()` to after the auth block:

```csharp
app.UseHttpsRedirection();

if (useAuth)
{
    app.UseAuthentication();
    app.UseAuthorization();
    app.MapControllers();
}

app.UseAntiforgery();   // ← moved here, after auth middleware

app.MapStaticAssets();
app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();
```

---

## Bug B: FluentUI.min.js 404 Not Found

### Symptom

```
GET https://localhost:5001/_content/Microsoft.FluentUI.AspNetCore.Components/js/FluentUI.min.js net::ERR_ABORTED 404 (Not Found)
```

Console error on every page load, even after successful sign-in.

### Root Cause: File Does Not Exist in FluentUI Blazor v4.x

[App.razor](../../../src/LawCorp.Mcp.Web/Components/App.razor) line 19 references a script that was part of FluentUI Blazor **v3.x** but was removed in v4.x:

```html
<script src="_content/Microsoft.FluentUI.AspNetCore.Components/js/FluentUI.min.js"></script>
```

In v3.x, this file handled Web Component initialization. In v4.x, the library was refactored to use pure Blazor/CSS rendering and no longer ships this file. Instead, FluentUI Blazor 4.x ships a `Microsoft.FluentUI.AspNetCore.Components.lib.module.js` Blazor JS initializer, which `blazor.web.js` discovers and loads automatically — no manual script tag needed or correct.

The app is running v4.14.0 (per the csproj), so this stale script reference produces a guaranteed 404 on every load.

**Files affected:**
- [App.razor](../../../src/LawCorp.Mcp.Web/Components/App.razor) — line 19

**Fix:**
Remove the FluentUI script tag. The CSS reboot reference on line 8 is correct and stays:

```html
@* Keep this — CSS exists in v4.x *@
<link rel="stylesheet" href="_content/Microsoft.FluentUI.AspNetCore.Components/css/reboot.css" />

@* Remove this — file does not exist in v4.x *@
<script src="_content/Microsoft.FluentUI.AspNetCore.Components/js/FluentUI.min.js"></script>
```

---

## Out of Scope: Access Token Attached to API Calls

The bug report also asks whether the access token is being attached to MCP server API calls. This is a separate concern from these two bugs — it relates to the token passthrough story [8.2.2](../8.2.2-session-token-passthrough.md) and is not caused by either bug above.

---

## Fix Summary

| Bug | File | Change |
|-----|------|--------|
| A (primary) — Enhanced nav intercepts OIDC | `LoginDisplay.razor` lines 22, 28 | Add `data-enhance-nav="false"` to sign-in and sign-out `<a>` tags |
| A (secondary) — Wrong middleware order | `Program.cs` line 43 | Move `UseAntiforgery()` to after the `if (useAuth)` block |
| B — FluentUI script 404 | `App.razor` line 19 | Remove the `<script>` tag for `FluentUI.min.js` |

All three changes are small, targeted, and low-risk.
