# 8.1.2.1: OIDC Middleware and Service Configuration

**Status:** DONE
**Type:** Task
**Story:** [8.1.2: Entra ID OIDC Sign-In](./8.1.2-entra-id-oidc-auth.md)

## Description

Configure `Program.cs` to register OIDC authentication via `Microsoft.Identity.Web` when `UseAuth=true`, and ensure auth infrastructure services are available in both modes so `<AuthorizeView>` Blazor components work without exceptions.

## Implementation

- `AddMicrosoftIdentityWebApp()` registers OIDC with Entra ID when `UseAuth=true`
- `.EnableTokenAcquisitionToCallDownstreamApi()` enables acquiring tokens for the MCP server API
- `AddControllersWithViews().AddMicrosoftIdentityUI()` maps the `/MicrosoftIdentity/Account/*` controller endpoints for sign-in/sign-out
- `AddAuthorization()` is called unconditionally so `<AuthorizeView>` resolves its services in both modes
- `AddCascadingAuthenticationState()` propagates auth state to all Blazor components
- Auth middleware (`UseAuthentication`, `UseAuthorization`, `MapControllers`) only runs when `UseAuth=true`

## Key File

`src/LawCorp.Mcp.Web/Program.cs`
