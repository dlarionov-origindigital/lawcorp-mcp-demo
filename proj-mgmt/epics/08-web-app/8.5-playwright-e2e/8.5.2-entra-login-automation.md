# 8.5.2: Entra ID login automation (auth setup per persona)

**Status:** BACKLOG
**Type:** Story
**Feature:** [8.5: Playwright E2E Tests](./8.5-playwright-e2e.md)
**Tags:** `+web-app` `+testing` `+auth` `+e2e`

---

As an E2E test suite,
I want to automate the Entra ID login flow for each of the six personas and cache the authenticated state,
So that subsequent tests can run as any persona without repeating the login flow.

## Context

Playwright's `storageState` feature saves cookies and local storage after login, enabling subsequent tests to skip the login page entirely. Each persona gets its own storage state file.

## Implementation Steps

- [ ] Create `AuthSetup.cs` with a setup method per persona:
  - Navigate to the Blazor app's root URL → expect redirect to `login.microsoftonline.com`
  - Fill in the email field with the persona's UPN (e.g., `harvey@yourtenant.onmicrosoft.com`)
  - Click "Next" → fill in the password field
  - Click "Sign in" → handle "Stay signed in?" prompt if it appears
  - Wait for redirect back to the Blazor app → verify the app loaded (e.g., check for the identity panel or home page content)
  - Save `storageState` to `.auth/{persona-name}.json`
- [ ] Store persona credentials in environment variables (not in code):
  - `E2E_HARVEY_EMAIL`, `E2E_HARVEY_PASSWORD`
  - `E2E_KIM_EMAIL`, `E2E_KIM_PASSWORD`
  - ... (one pair per persona)
- [ ] Create a `.env.example` file documenting the required environment variables
- [ ] Run auth setup as a Playwright "setup project" that other test projects depend on (so it runs once before all tests)
- [ ] Handle conditional access / MFA:
  - Recommend: disable MFA for test accounts via conditional access policy
  - If MFA is unavoidable: document the limitation and suggest ROPC as a fallback for CI

## Acceptance Criteria

- [ ] Auth setup produces six `.auth/*.json` storage state files (one per persona)
- [ ] A test using Harvey's storage state is authenticated as Harvey without any login interaction
- [ ] Auth setup runs only once per test suite execution (not once per test)
- [ ] Credentials are loaded from environment variables (not hardcoded)
- [ ] `.env` file with real credentials is gitignored; `.env.example` is tracked

## Notes

Persona credentials are tenant-specific. Each developer/CI environment needs its own set.
See [Playwright — Handling Azure AD Auth](https://marcusfelling.com/blog/2023/handling-azure-ad-authentication-with-playwright/) for the established pattern.
