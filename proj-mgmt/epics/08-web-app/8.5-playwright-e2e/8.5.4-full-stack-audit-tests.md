# 8.5.4: Full-stack audit verification tests

**Status:** BACKLOG
**Type:** Story
**Feature:** [8.5: Playwright E2E Tests](./8.5-playwright-e2e.md)
**Tags:** `+web-app` `+testing` `+auth` `+e2e`

---

As a security auditor,
I want automated tests that verify the full-stack communication trace — from browser login to MCP tool response — includes correct authorization metadata at every layer,
So that I can certify the identity passthrough architecture is working as designed.

## Test Scenarios

| # | Scenario | Verification |
|---|---|---|
| 1 | Harvey invokes `cases_search` | The MCP trace viewer shows `Authorization: Bearer •••••` on the outbound request |
| 2 | Harvey invokes `cases_search` | The identity panel shows "Harvey Specter, Partner, M&A" |
| 3 | Harvey invokes `cases_search` | The audit log viewer shows a "Granted" decision for the tool call |
| 4 | Kim invokes a billing tool | The audit log viewer shows a "Denied" decision with reason |
| 5 | Vinny reads a privileged document | The audit log shows "Redacted" for the privileged field |
| 6 | Any persona invokes any tool | The MCP response includes the correct `userId` in the server's audit trail |

## Implementation Steps

- [ ] Create `AuditVerificationTests.cs`
- [ ] Each test:
  1. Loads the Blazor app with the persona's storage state
  2. Navigates to the tools page and invokes a tool
  3. Navigates to the trace viewer (`/trace`) and asserts on the MCP request/response content
  4. Navigates to the audit log (`/audit`) and asserts on the authorization decision
  5. Verifies consistency: the tool result matches the audit decision (e.g., denied tool = no data in result)
- [ ] Screenshot capture on failure for debugging
- [ ] Optional: query the MCP server's audit log table directly (via a test-only API endpoint or DB query) to cross-verify the UI display

## Acceptance Criteria

- [ ] All 6 scenarios pass
- [ ] Tests verify the UI's audit display matches the server's actual authorization behavior
- [ ] The full chain is validated: login identity → MCP request header → server identity resolution → authorization decision → filtered result → audit log
- [ ] Test output includes enough detail for a non-developer to understand what was verified

## Dependencies

- 8.3 (auth audit UI) — the trace viewer and audit log must be functional
- 8.5.2 (auth setup) — storage state files must exist
- 1.3.4 (audit logging) — server-side audit entries must exist
