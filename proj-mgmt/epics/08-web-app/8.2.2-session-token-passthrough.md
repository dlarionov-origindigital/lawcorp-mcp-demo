# 8.2.2: Per-session MCP client with user token passthrough

**Status:** BACKLOG
**Type:** Task
**Feature:** [8.2: MCP Client Integration](./8.2-mcp-client-integration.md)
**Tags:** `+web-app` `+auth` `+mcp-client`
**ADR:** [ADR-005](../../decisions/005-oauth-identity-passthrough.md)

---

Configure the MCP client service to inject the authenticated user's access token into every HTTP request to the MCP server, completing the identity passthrough chain from browser login to MCP tool execution.

## Context

The Blazor app authenticates the user via OIDC (8.1.2) and acquires an access token scoped to `api://<MCP-server-client-id>/access_as_user`. This token must be attached as `Authorization: Bearer <token>` to every request the `HttpClientTransport` sends to the MCP server.

In Interactive Server mode, the Blazor backend holds the user's session state (including the cached token). The MCP client connection lives server-side — tokens never reach the browser.

## Implementation Steps

- [ ] Inject `ITokenAcquisition` (from `Microsoft.Identity.Web`) into `McpClientService`
- [ ] Before each MCP server request, acquire the token: `await tokenAcquisition.GetAccessTokenForUserAsync(new[] { "api://<client-id>/access_as_user" })`
- [ ] Set the token on the `HttpClient` used by `HttpClientTransport`:
  ```csharp
  httpClient.DefaultRequestHeaders.Authorization =
      new AuthenticationHeaderValue("Bearer", token);
  ```
- [ ] Handle `MsalUiRequiredException` — if the token cache is empty or consent is needed, redirect the user to re-authenticate (Blazor Server can trigger a redirect via `NavigationManager`)
- [ ] Verify that each user session gets its own `HttpClient` instance (no shared static client that leaks tokens across sessions)

## Acceptance Criteria

- [ ] When Harvey Specter is logged in, the MCP server receives Harvey's token and resolves his identity
- [ ] When Kim Wexler is logged in (different browser/session), the MCP server receives Kim's token
- [ ] Two concurrent user sessions do not share tokens (session isolation)
- [ ] Token refresh happens transparently via MSAL's token cache
- [ ] If the token cannot be acquired (expired session, revoked consent), the user sees a re-login prompt

## Dependencies

- 8.1.2 (OIDC auth) — token acquisition must be configured
- 8.2.1 (MCP client service) — transport must be established
