# 6.4.4: Azure Foundry OAuth passthrough configuration

**Status:** BACKLOG
**Type:** Task
**Feature:** [6.4: Deployment to Azure Foundry](./6.4-deployment.md)
**Tags:** `+deployment` `+auth`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)

---

Configure the Azure AI Foundry MCP tool connection to use **OAuth identity passthrough** (individual authentication) so that each user's Entra ID identity flows through to the deployed MCP server, matching the architecture described in ADR-005.

## Implementation Steps

- [ ] In Foundry Agent configuration, set the MCP tool connection auth mode to **OAuth identity passthrough** (individual auth)
- [ ] Choose between managed OAuth (publisher-managed) or custom OAuth (own Entra app registration):
  - If **custom OAuth**: configure auth URL, token URL, refresh URL pointing to the MCP server's Entra app registration
  - Add the Foundry-provided redirect URL to the Entra app's redirect URIs
  - Set scopes to the minimum required: `User.Read`, `Calendars.Read`, `Calendars.ReadWrite`, `Sites.Read.All`, `Mail.Read` (adjust per implemented tools)
- [ ] Document the Foundry connection configuration steps (screenshots or Bicep/ARM if available)
- [ ] Verify the consent flow works end-to-end: first tool call triggers consent link → user consents → retry succeeds
- [ ] Verify that subsequent tool calls do not re-prompt for consent
- [ ] Document the difference between Foundry OAuth passthrough (production) and `FakeIdentityContext` (dev/test)

## Acceptance Criteria

- [ ] MCP tools deployed to Foundry execute under the calling user's identity
- [ ] The consent link flow works for first-time users
- [ ] Token refresh works transparently (no re-consent unless tokens are revoked)
- [ ] Configuration is documented and reproducible

## Notes

Depends on 6.4.2 (CI/CD pipeline) and 1.2.4 (downstream resource access) being complete.
See [ADR-005](../../decisions/005-oauth-identity-passthrough.md) for the architectural rationale and [docs/auth/passthrough.md](../../../docs/auth/passthrough.md) for the Foundry authentication analysis.
