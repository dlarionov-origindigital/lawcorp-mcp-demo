# 1.2.4: Downstream resource access via identity passthrough

**Status:** IN PROGRESS
**Type:** Story
**Feature:** [1.2: Authentication — Microsoft Entra ID](../1.2-authentication.md)
**Tags:** `+auth` `+foundation`
**ADR:** [ADR-005: OAuth identity passthrough](../../../decisions/005-oauth-identity-passthrough.md)
**Setup Guide:** [`docs/auth-config.md`](../../../docs/auth-config.md)

---

As a Law-Corp attorney using an AI assistant,
I want my identity to flow through to downstream resources — SharePoint, Outlook Calendar, database records — when I invoke MCP tools,
So that I only see and modify data I'm personally authorized to access, just as if I were using those systems directly.

## Context

[ADR-005](../../../decisions/005-oauth-identity-passthrough.md) establishes OAuth identity passthrough as the canonical access pattern. This story implements the downstream side: once the user's Entra ID token is validated (1.2.1) and can be exchanged via OBO (1.2.2), each downstream resource type needs an integration layer that carries the user's identity through to the final API call or database query.

Two distinct patterns are used, both starting from the same inbound bearer token:

| Downstream Target | Pattern | Mechanism |
|---|---|---|
| Microsoft Graph (SharePoint, Calendar, Mail) | OBO token exchange | `IDownstreamTokenProvider` acquires a Graph-scoped token via OBO, then Graph SDK calls use that token |
| Local SQL Express database | Claim-based filtering | `IFirmIdentityContext` extracts role/scope from the JWT; EF Core global query filters and auth handlers enforce access |

## Tasks

| ID | Title | Type | Status |
|---|---|---|---|
| [1.2.4.1](./1.2.4.1-graph-client-obo-provider.md) | Graph SDK client with OBO token provider | Task | IN PROGRESS |
| [1.2.4.2](./1.2.4.2-sharepoint-document-access.md) | SharePoint document access via user identity | Task | BACKLOG |
| [1.2.4.3](./1.2.4.3-outlook-calendar-access.md) | Outlook calendar access via user identity | Task | BACKLOG |
| [1.2.4.4](./1.2.4.4-consent-flow-handling.md) | Consent flow handling and retry | Task | BACKLOG |
| [1.2.4.5](./1.2.4.5-database-identity-scoped-access.md) | Database access scoped by identity context | Task | IN PROGRESS |
| [1.2.4.6](./1.2.4.6-stdio-transport-auth.md) | Authentication support for stdio transport | Task | BACKLOG |
| [BUG](./1.2.4-bug-generic-host-auth-di-failure.md) | Generic Host + AddAuthorization DI crash when UseAuth=true | Bug | RESOLVED |

## Acceptance Criteria

- [ ] MCP tools that access Graph resources use the calling user's identity (via OBO), not a shared service account
- [ ] MCP tools that access the local database scope results to the calling user's role and assignments
- [ ] A Partner persona can access resources that an Intern persona cannot, end-to-end
- [ ] Consent errors from Graph are surfaced as structured MCP error responses (not unhandled exceptions)
- [ ] Token caching prevents redundant OBO exchanges within a single request scope

## Dependencies

- 1.2.1 (Entra ID auth middleware) — token validation must be in place
- 1.2.2 (OBO token exchange) — OBO infrastructure must be available
- 1.3.5 (`IFirmIdentityContext`) — identity abstraction must be defined

## Persona Test Matrix

Each task in this story should be verifiable against the persona fixture (Feature 7.2):

| Persona | Graph Access | DB Access |
|---|---|---|
| Harvey Specter (Partner) | Full Graph scopes; own mailbox, calendar, SharePoint sites | All M&A cases; full billing; all documents |
| Kim Wexler (Associate) | Own mailbox, calendar | Assigned cases only; own time entries |
| Alan Shore (OfCounsel) | Own mailbox, calendar | Own practice group cases (read-only) |
| Erin Brockovich (Paralegal) | Limited Graph scopes (no mail send) | Assigned cases; no billing |
| Elle Woods (LegalAssistant) | Harvey's calendar (delegated); own mail | Harvey's cases only |
| Vinny Gambini (Intern) | Own calendar only | Assigned cases; redacted privileged content |
