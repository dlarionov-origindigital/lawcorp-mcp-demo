# Fix Plan: Migrate to WebApplication host when UseAuth=true

**Bug:** [`1.2.4-bug-generic-host-auth-di-failure.md`](./1.2.4-bug-generic-host-auth-di-failure.md)
**Status:** IMPLEMENTED

---

## Problem Summary

`AddAuthorization()` in .NET 9 depends on `EndpointDataSource`, which is only registered by the web host (`WebApplication.CreateBuilder`). Our `Program.cs` uses the Generic Host (`Host.CreateApplicationBuilder`), so the DI container crashes at startup when `UseAuth=true`.

## Options

### Option A: Dual-host branching in Program.cs (Recommended)

Branch early in `Program.cs` based on `UseAuth`:

- **`UseAuth=true`** → `WebApplication.CreateBuilder` + HTTP/SSE transport + auth middleware pipeline
- **`UseAuth=false`** → `Host.CreateApplicationBuilder` + stdio transport (current behavior, unchanged)

This is the approach already documented in [`docs/local-mcp-inspect-auth.md`](../../../../docs/local-mcp-inspect-auth.md) Step 2b.

**Pros:**
- Clean separation — the auth path gets a proper web host with routing, Kestrel, middleware pipeline
- Stdio path is untouched — no risk of breaking the anonymous/demo mode
- Aligns with MCP SDK's `WithHttpTransport()` / `MapMcp()` pattern
- Both the `ModelContextProtocol.AspNetCore` package docs and the `local-mcp-inspect-auth.md` guide already describe this

**Cons:**
- Two host configurations in one file (can extract to helper methods to keep it readable)
- Requires adding the `ModelContextProtocol.AspNetCore` NuGet package

**Estimated scope:** `Program.cs` rewrite (~40 lines per branch), one new NuGet package

### Option B: Minimal patch — add routing services to Generic Host

Register the missing service on the Generic Host without switching to `WebApplication`:

```csharp
if (useAuth)
{
    services.AddRouting();   // registers EndpointDataSource
    services.AddEntraIdAuthentication(builder.Configuration);
}
```

**Pros:**
- Smallest code change (one line)
- No transport migration needed

**Cons:**
- **Papering over the real issue.** Auth middleware (`UseAuthentication`, `UseAuthorization`, `UserContextResolutionMiddleware`) needs an HTTP pipeline to function. Adding `AddRouting()` silences the DI error but the auth middleware has no request pipeline to run in — authenticated requests will never reach the resolution middleware over stdio
- Creates a false sense of working auth when the server is still stdio-only
- `AddRouting()` on a Generic Host is an unsupported pattern; future .NET updates could break it

**Verdict:** Not recommended. Fixes the crash but auth still can't work over stdio.

### Option C: Switch entirely to WebApplication (drop Generic Host)

Always use `WebApplication.CreateBuilder`, even for the non-auth path. Use `WithStdioServerTransport()` on the web host when `UseAuth=false` and `WithHttpTransport()` when `UseAuth=true`.

**Pros:**
- Single builder — simpler code, no branching
- ASP.NET Core services available in all modes (useful if we later add health checks, metrics, etc.)

**Cons:**
- Changes the non-auth startup path which currently works
- `WithStdioServerTransport()` on a `WebApplication` is an unusual pattern — needs validation that the MCP SDK supports it
- May pull in Kestrel and middleware overhead for stdio mode where it's unnecessary
- Risk of breaking Claude Desktop/VS Code integration which expects pure stdio with no HTTP

**Verdict:** Worth exploring long-term, but riskier for a bug fix.

---

## Recommended Approach: Option A

### Implementation Steps

#### 1. Add the ASP.NET Core MCP transport package

```bash
cd src/LawCorp.Mcp.Server
dotnet add package ModelContextProtocol.AspNetCore --prerelease
```

This provides `WithHttpTransport()` and `MapMcp()`.

#### 2. Restructure Program.cs into two host branches

Extract shared setup (database, logging, persona config) into helper methods, then branch:

```
Program.cs
├── Read UseAuth from a minimal config
├── if (UseAuth)
│   ├── WebApplication.CreateBuilder(args)
│   ├── AddLawCorpDatabase(...)
│   ├── AddEntraIdAuthentication(...)
│   ├── AddMcpServer().WithHttpTransport().WithToolsFromAssembly()
│   ├── app.UseAuthentication()
│   ├── app.UseAuthorization()
│   ├── app.UseMiddleware<UserContextResolutionMiddleware>()
│   ├── app.MapMcp()
│   ├── Seed if configured
│   └── app.RunAsync()
└── else (UseAuth=false)
    ├── Host.CreateApplicationBuilder(args)  [current code, unchanged]
    ├── AddSingleton<IUserContext, AnonymousUserContext>()
    ├── AddMcpServer().WithStdioServerTransport().WithToolsFromAssembly()
    ├── Seed if configured
    └── app.RunAsync()
```

#### 3. Configure Kestrel for local dev

Add to `appsettings.Development.json` (only relevant when `UseAuth=true`):

```json
{
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://localhost:5000"
      }
    }
  }
}
```

#### 4. Update launchSettings.json

Add a profile for the authenticated/HTTP mode:

```json
{
  "LawCorp.Mcp.Server (Auth)": {
    "commandName": "Project",
    "environmentVariables": {
      "DOTNET_ENVIRONMENT": "Development"
    },
    "applicationUrl": "http://localhost:5000"
  }
}
```

#### 5. Validate both modes

| Mode | Command | Expected |
|---|---|---|
| `UseAuth=false` | `dotnet run --project src/LawCorp.Mcp.Server` | Starts stdio, MCP Inspector via stdio works |
| `UseAuth=true` | `dotnet run --project src/LawCorp.Mcp.Server` | Starts Kestrel on :5000, MCP Inspector via SSE/HTTP works with Bearer token |

#### 6. Update docs

- `docs/local-mcp-inspect-auth.md` — remove "future step" language; this is now the implemented path
- `docs/auth-config.md` — update Step 8 (verify) to reflect the HTTP startup

### Files Changed

| File | Change |
|---|---|
| `LawCorp.Mcp.Server.csproj` | Add `ModelContextProtocol.AspNetCore` package |
| `Program.cs` | Dual-host branching |
| `appsettings.Development.json.example` | Add Kestrel endpoint |
| `Properties/launchSettings.json` | Add auth profile |
| `docs/local-mcp-inspect-auth.md` | Update to reflect implementation |
| `docs/auth-config.md` | Update verification step |

### Risks

1. **MCP SDK version jump**: Moving from `0.9.0-preview.2` to `1.0.0-rc.1+` may have breaking API changes in tool registration. Check the [changelog](https://github.com/modelcontextprotocol/csharp-sdk/releases).
2. **`WithHttpTransport()` availability**: Confirm `ModelContextProtocol.AspNetCore` exposes this method in the version we install. The API may have been renamed (e.g., `WithStreamableHttpTransport`).
3. **Stdio regression**: The `UseAuth=false` path must remain byte-for-byte identical to the current working stdio behavior. No shared state changes should leak across the branch.
