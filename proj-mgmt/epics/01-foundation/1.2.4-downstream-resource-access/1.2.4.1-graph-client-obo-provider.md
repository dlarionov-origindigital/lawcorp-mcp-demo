# 1.2.4.1: Graph SDK client with OBO token provider

**Status:** BACKLOG
**Type:** Task
**Story:** [1.2.4: Downstream resource access](./1.2.4-downstream-resource-access.md)
**Tags:** `+auth` `+foundation`

---

Configure the Microsoft Graph SDK `GraphServiceClient` with a custom `IAuthenticationProvider` (or `TokenCredential`) that obtains Graph-scoped tokens via the On-Behalf-Of flow established in story 1.2.2. This provides the shared plumbing that all Graph-calling tasks (1.2.4.2, 1.2.4.3) depend on.

## Implementation Steps

- [ ] Create `IDownstreamTokenProvider` interface in `LawCorp.Mcp.Core` with method `Task<string> AcquireTokenOnBehalfOfAsync(string[] scopes)`
- [ ] Implement `OboDownstreamTokenProvider : IDownstreamTokenProvider` in `LawCorp.Mcp.Server` using `IConfidentialClientApplication.AcquireTokenOnBehalfOf()` from MSAL
- [ ] Register `IDownstreamTokenProvider` as a scoped service (per-request, tied to the inbound user token)
- [ ] Create `GraphClientFactory` that accepts `IDownstreamTokenProvider` and returns a `GraphServiceClient` pre-configured with an auth provider that calls `AcquireTokenOnBehalfOfAsync` for the requested scopes
- [ ] Implement token caching via MSAL's built-in token cache (in-memory for dev, distributed cache for production)
- [ ] Register `GraphClientFactory` in DI as scoped

## Acceptance Criteria

- [ ] `GraphServiceClient` obtained from the factory uses the calling user's identity for all Graph API calls
- [ ] Token cache prevents redundant OBO exchanges for the same user + scope within the cache lifetime
- [ ] If the inbound token is missing or invalid, `AcquireTokenOnBehalfOfAsync` throws a typed exception that the tool handler can catch and return as a structured MCP error
- [ ] No shared/static `GraphServiceClient` instances â€” each request scope gets its own client bound to the request's user

## Notes

Depends on 1.2.2 (OBO token exchange) for the underlying MSAL configuration.
The `IDownstreamTokenProvider` abstraction allows tests to substitute a mock that returns pre-built tokens without hitting Entra.
