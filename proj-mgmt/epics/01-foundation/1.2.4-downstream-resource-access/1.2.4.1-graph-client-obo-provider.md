# 1.2.4.1: Graph SDK client with OBO token provider

**Status:** IN PROGRESS
**Type:** Task
**Story:** [1.2.4: Downstream resource access](./1.2.4-downstream-resource-access.md)
**Tags:** `+auth` `+foundation`
**Setup Guide:** [`docs/auth-config.md`](../../../../docs/auth-config.md)

---

Configure the Microsoft Graph SDK `GraphServiceClient` with a custom `IAuthenticationProvider` (or `TokenCredential`) that obtains Graph-scoped tokens via the On-Behalf-Of flow established in story 1.2.2. This provides the shared plumbing that all Graph-calling tasks (1.2.4.2, 1.2.4.3) depend on.

## Implementation Steps

- [x] Create `IDownstreamTokenProvider` interface in `LawCorp.Mcp.Core` — `src/LawCorp.Mcp.Core/Auth/IDownstreamTokenProvider.cs`
- [x] Implement `OboDownstreamTokenProvider : IDownstreamTokenProvider` in `LawCorp.Mcp.Server` using `Microsoft.Identity.Web`'s `ITokenAcquisition` — `src/LawCorp.Mcp.Server/Auth/OboDownstreamTokenProvider.cs`
- [x] Register `IDownstreamTokenProvider` as a scoped service via `AuthServiceCollectionExtensions.AddEntraIdAuthentication()`
- [ ] Create `GraphClientFactory` that accepts `IDownstreamTokenProvider` and returns a `GraphServiceClient` pre-configured with an auth provider that calls `AcquireTokenAsync` for the requested scopes
- [x] Implement token caching via `Microsoft.Identity.Web`'s `AddInMemoryTokenCaches()` (in-memory for dev, distributed cache for production)
- [ ] Register `GraphClientFactory` in DI as scoped

## Acceptance Criteria

- [ ] `GraphServiceClient` obtained from the factory uses the calling user's identity for all Graph API calls
- [ ] Token cache prevents redundant OBO exchanges for the same user + scope within the cache lifetime
- [ ] If the inbound token is missing or invalid, `AcquireTokenOnBehalfOfAsync` throws a typed exception that the tool handler can catch and return as a structured MCP error
- [ ] No shared/static `GraphServiceClient` instances — each request scope gets its own client bound to the request's user

## Notes

Depends on 1.2.2 (OBO token exchange) for the underlying MSAL configuration.
The `IDownstreamTokenProvider` abstraction allows tests to substitute a mock that returns pre-built tokens without hitting Entra.
