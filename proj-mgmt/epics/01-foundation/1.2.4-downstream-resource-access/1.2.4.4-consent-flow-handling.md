# 1.2.4.4: Consent flow handling and retry

**Status:** BACKLOG
**Type:** Task
**Story:** [1.2.4: Downstream resource access](./1.2.4-downstream-resource-access.md)
**Tags:** `+auth` `+foundation`

---

Implement structured handling of OAuth consent requirements that arise when a user's token lacks the necessary Graph scopes, and surface these as actionable MCP responses that the client can act on.

## Context

When Azure AI Foundry's OAuth passthrough encounters a tool call requiring Graph scopes the user hasn't yet consented to, the Foundry runtime returns an `oauth_consent_request` containing a `consent_link`. The MCP server must:

1. Detect when a Graph call fails due to insufficient consent
2. Return a structured MCP error response that the client can interpret
3. Support retry after the user completes consent

After first consent, users are typically not prompted again unless refresh tokens are revoked.

## Implementation Steps

- [ ] Create a custom exception type `ConsentRequiredException` that captures the required scopes and, if available, the consent URL
- [ ] In `OboDownstreamTokenProvider` (from 1.2.4.1): catch MSAL `MsalUiRequiredException` and wrap it as `ConsentRequiredException`
- [ ] In the MCP tool handler error pipeline: catch `ConsentRequiredException` and return a structured MCP error response with:
  - Error code indicating consent is required
  - The required scopes
  - A message instructing the client to surface the consent flow
- [ ] Document the expected client-side behavior: surface the consent link to the user, then retry the original tool call using `previous_response_id` (Foundry pattern)
- [ ] Add a configuration flag `Auth:RequirePreConsent` (default `false`) â€” when `true`, the server validates that all required scopes are present in the inbound token at request time, before attempting the OBO exchange

## Acceptance Criteria

- [ ] A first-time Graph tool call for a user who hasn't consented returns a structured consent-required error (not a 500)
- [ ] The error response includes the specific scopes that need consent
- [ ] After the user consents and retries, the tool call succeeds
- [ ] The consent flow does not affect other users' requests (scoped to the individual user)
- [ ] Pre-consent validation (when enabled) catches missing scopes before the OBO round-trip

## Notes

Depends on 1.2.4.1 (Graph client with OBO provider).
The consent link itself is generated by Foundry, not by the MCP server. The MCP server's responsibility is to detect the consent gap and return a response the client/Foundry can act on.
