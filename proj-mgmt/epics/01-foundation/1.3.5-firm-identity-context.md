# 1.3.5: Define `IFirmIdentityContext` abstraction

**Status:** BACKLOG
**Type:** Task
**Feature:** [1.3: Custom Authorization Layer](./1.3-authorization.md)
**Tags:** `+auth` `+foundation`

---

Define the `IFirmIdentityContext` interface that the authorization layer reads user identity from, and provide the production implementation that resolves claims from the validated Entra ID JWT. This abstraction is what makes the authorization layer testable without real Entra tokens.

## Why this exists

The ASP.NET Core auth middleware validates the JWT, but the MCP tool handlers and authorization handlers need a typed, domain-aware identity object — not raw claim strings. If handlers read directly from `HttpContext.User`, they are untestable without a real HTTP pipeline and real tokens.

`IFirmIdentityContext` provides:
- The current user's `UserId` (mapped from Entra Object ID claim)
- Their `AttorneyRole` or staff role
- Their `PracticeGroupId`
- Their list of assigned case IDs (for row-level filtering)
- Their `AssignedAttorneyId` (for LegalAssistant / Intern)
- A convenience method `HasRole(AttorneyRole)` and `IsInPracticeGroup(int)`

See [ADR-004](../../decisions/004-dual-transport-web-api-primary.md) for the full rationale.

## Implementation Steps

- [ ] Define `IFirmIdentityContext` interface in `LawCorp.Mcp.Core` (so it can be referenced by both the server and the test project without circular dependencies)
- [ ] Implement `EntraFirmIdentityContext : IFirmIdentityContext` in `LawCorp.Mcp.Server` — reads from `IHttpContextAccessor` and maps JWT claims to the interface's typed properties
- [ ] Register `IFirmIdentityContext` → `EntraFirmIdentityContext` as a **scoped** service in `Program.cs` (scoped to the HTTP request lifetime)
- [ ] Update `1.3.1` authorization handler to take `IFirmIdentityContext` as a constructor dependency instead of reading raw claims
- [ ] Update `1.3.2` EF Core global query filters to receive the identity context via a scoped factory rather than reading `IHttpContextAccessor` directly

## Acceptance Criteria

- [ ] `IFirmIdentityContext` is defined in `LawCorp.Mcp.Core` with no dependency on ASP.NET Core packages
- [ ] `EntraFirmIdentityContext` correctly maps the Entra ID `roles` claim to `AttorneyRole` enum values
- [ ] Authorization handlers compile and pass their unit tests using a `FakeIdentityContext` double (the double lives in the test project, not here)
- [ ] DI registration is scoped — each request gets its own resolved identity

## Notes

This task is a prerequisite for Epic 7 feature 7.1.2 (`FakeIdentityContext` test double).
