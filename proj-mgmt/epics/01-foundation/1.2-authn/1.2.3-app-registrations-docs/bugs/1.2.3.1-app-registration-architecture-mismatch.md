# BUG 1.2.3.1: App registration architecture insufficient for true OBO demonstration

**Status:** OPEN
**Type:** Bug
**Story:** [1.2.3: Set up Entra ID app registrations documentation](../1.2.3-app-registrations-docs.md)
**Tags:** `+auth`, `+architecture`

---

## Summary

The current `docs/auth-config.md` guide describes **two** Entra ID app registrations — one for the MCP server API and one for the Blazor web app — but the OBO (On-Behalf-Of) flow demonstrated only targets **Microsoft Graph** as the downstream resource. This means the solution never actually proves that user identity flows through to a **custom downstream API**, which is the core value proposition stated in [ADR-005](../../../../decisions/005-oauth-identity-passthrough.md):

> "the MCP server should only be able to do what the logged-in user can do"

The OBO exchange to Microsoft Graph is a valid demonstration of OBO mechanics, but Microsoft Graph is a **first-party Microsoft service** — it does not prove the architecture works for the enterprise pattern where the MCP server calls **your own APIs** on behalf of the user. This is the pattern most enterprise customers need: an MCP server that acts as a facade dispatching user-delegated calls to multiple backend services.

## Current State

| Component | App Registration | Auth Flow |
|---|---|---|
| Blazor Web App (MCP client) | `LawCorp Web App` — OIDC authorization code | User signs in → web app gets token → calls MCP server via OBO scope |
| MCP Server API | `LawCorp MCP Server` — JWT Bearer + OBO | Validates inbound token → OBO exchange to Graph |
| Microsoft Graph | N/A (Microsoft-owned) | Receives OBO token → returns user's data |
| Local SQL Express database | N/A (no token needed) | Claim extraction from inbound JWT → EF Core query filters |

**What's missing:** There is no custom downstream API with its **own** app registration. The MCP server never performs OBO to an API that *we* control. Without this, we cannot demonstrate:

1. A third app registration with its own `api://` scope
2. The MCP server performing OBO to exchange the user's token for a downstream-API-scoped token
3. The downstream API validating the OBO token and enforcing its own authorization
4. True multi-hop identity delegation: User → Web App → MCP Server → Downstream API

## Expected State

A three-tier (or more) app registration architecture:

| Component | App Registration | Auth Flow |
|---|---|---|
| Blazor Web App (MCP client) | `LawCorp Web App` | OIDC → acquires token for MCP server scope |
| MCP Server API | `LawCorp MCP Server` | Validates JWT → OBO to downstream API scope **and** Graph scopes |
| External Downstream API | `LawCorp External API` (NEW) | Validates OBO token → enforces its own authorization → returns user-scoped data |
| Microsoft Graph | Microsoft-owned | Receives OBO token → returns M365 data |

## Architectural Implications

This bug has cascading implications:

1. **Solution structure** — The external API must be a separate runnable service (not a project reference within the MCP server). Currently everything lives under `src/` in a tightly coupled solution. The external API should be independently deployable.

2. **MCP tool dispatch** — Tools currently access data through direct EF Core `DbContext` injection. If some data comes from an external API, tools need an abstraction layer (repository, CQRS/MediatR, or similar) so they dispatch actions without knowing whether the handler resolves the data locally or via a network call.

3. **App registration documentation** — `docs/auth-config.md` needs a third app registration section covering the external API's scopes, permissions, and OBO configuration.

4. **Project management** — New stories/tasks may be needed for the external API service, the CQRS dispatch layer, and updated app registration documentation.

## Reproduction

1. Follow `docs/auth-config.md` Steps 1–10
2. Enable auth (`UseAuth=true`, `Transport=http`)
3. Sign in as Harvey Specter via the Blazor web app
4. Invoke an MCP tool that accesses case data → succeeds (local DB, claim-based filtering)
5. **Observe:** There is no tool that performs OBO to a custom downstream API — only to Microsoft Graph
6. **Observe:** There is no third app registration in the Azure portal for a custom downstream API

## Impact

- The reference architecture does not demonstrate the most common enterprise MCP pattern (facade over custom APIs)
- Developers following this guide will not learn how to set up multi-hop OBO to their own services
- The `IDownstreamTokenProvider` abstraction exists but is only exercised against Graph, not against a custom API with its own token validation

## Research

See [RESEARCH-app-registration-architecture.md](../RESEARCH-app-registration-architecture.md) for a detailed plan to address this gap, including architecture options, authoritative references, and proposed project management changes.

## Acceptance Criteria

- [ ] Research plan reviewed and approach selected
- [ ] Project management files updated with new/modified epics, features, and stories
- [ ] This bug closed when the research plan is converted into actionable work items
