# 1.2.1: Implement Entra ID authentication middleware

**Status:** IN PROGRESS
**Type:** Story
**Feature:** [1.2: Authentication — Microsoft Entra ID](./1.2-authentication.md)
**Tags:** `+auth`
**Setup Guide:** [`docs/auth-config.md`](../../../docs/auth-config.md)

---

As a [Law-Corp attorney using an AI assistant],
I want [my Entra ID identity to be validated on every request],
So that [only authenticated users can access MCP tools and resources].

- [x] Configure Microsoft Identity Web for token validation — `AuthServiceCollectionExtensions.AddEntraIdAuthentication()` calls `AddMicrosoftIdentityWebApi()`
- [x] Set up JWT Bearer authentication scheme — `Microsoft.Identity.Web` v4.3.0 configures JWT Bearer from `AzureAd` config section
- [x] Map Entra ID claims to application identity (roles, groups, user ID) — `UserContextResolutionMiddleware` maps `oid` claim → `Attorney.EntraObjectId` → `EntraIdUserContext`
- [x] Configure token validation parameters (audience, issuer, signing keys) — driven by `AzureAd` section in `appsettings.json`

## Acceptance Criteria

- [x] Valid Entra ID tokens are accepted — JWT Bearer middleware validates tokens
- [ ] Invalid/expired tokens return 401 — requires HTTP transport to test end-to-end
- [x] Claims are available in HttpContext for downstream use — `UserContextResolutionMiddleware` populates `HttpContext.Items`

## Notes

Depends on 1.1.2 (MCP skeleton) being complete.
