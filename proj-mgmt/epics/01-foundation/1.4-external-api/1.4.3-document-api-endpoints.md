# 1.4.3: Implement document API endpoints with OBO token validation

**Status:** DONE
**Type:** Story
**Feature:** [1.4: External Downstream API Service](./1.4-external-api.md)
**Tags:** `+auth`, `+api`

---

As a Law-Corp attorney invoking MCP document tools,
I want the external API to return only documents I'm authorized to see,
So that multi-hop OBO identity delegation is enforced end-to-end.

The external API simulates a document management system (like iManage or NetDocuments). It exposes a REST API for case documents and enforces its own authorization based on the user identity in the OBO token.

- [x] Implement `GET /api/documents?query=&documentType=&caseId=&page=&pageSize=` — search/list documents with filtering
- [x] Implement `GET /api/documents/{id}` — get a single document with content
- [ ] Implement `POST /api/documents` — create a document on a case (requires `data.write` scope)
- [x] Implement authorization logic: extract user identity via `CallerIdentity.FromClaimsPrincipal()`, enforce access via `DmsAccessRule` entity mapping
- [x] Return 403 when the user's role does not have `CanRead` access to the workspace
- [x] Privileged documents hidden from Intern/Paralegal/LegalAssistant roles

## Acceptance Criteria

- [x] All endpoints require a valid OBO token (`[Authorize]` attribute — 401 for missing/invalid tokens)
- [x] Document results scoped by role-based workspace access rules (`DmsAccessRule`)
- [ ] `POST` requires the `data.write` scope in the token's `scp` claim
- [x] Partners access all workspaces; Associates access all except restricted-only; Interns/Paralegals restricted from privileged docs
- [x] 403 returned when workspace access denied or privileged document access denied

## Dependencies

- 1.4.1 (project creation)
- 1.4.2 (app registration)

## Notes

The external API has its own database (`LawCorpDms`) with `DmsDbContext`. Its domain model consists of `DmsWorkspace` (mapped to legal matters), `DmsDocument` (documents within workspaces), and `DmsAccessRule` (role-to-workspace permission mapping). This isolated database simulates a real-world document management system with its own authorization logic that is independent of the MCP server's authorization layer.
