# 1.4.4: MCP server OBO token exchange to external API

**Status:** BACKLOG
**Type:** Story
**Feature:** [1.4: External Downstream API Service](./1.4-external-api.md)
**Tags:** `+auth`, `+obo`
**ADR:** [ADR-005: OAuth identity passthrough](../../../decisions/005-oauth-identity-passthrough.md)

---

As the MCP server processing a document-related tool call,
I want to acquire an OBO token scoped to the external API,
So that I can call the external API on behalf of the authenticated user.

- [ ] Extend `IDownstreamTokenProvider` (or `OboDownstreamTokenProvider`) to support multiple downstream API configurations
- [ ] Add `DownstreamApis:ExternalApi` config section with `BaseUrl` and `Scopes`
- [ ] Implement HTTP client for the external API that attaches the OBO token as a Bearer header
- [ ] Register the external API HTTP client in DI (typed or named `HttpClient`)
- [ ] Handle token acquisition failures (consent, expired, etc.) with structured MCP error responses

## Acceptance Criteria

- [ ] `IDownstreamTokenProvider.GetTokenAsync("ExternalApi")` returns a valid OBO token for the external API's scope
- [ ] The OBO token's `aud` claim matches the external API's `api://` Application ID URI
- [ ] Token caching works for external API tokens (same cache strategy as Graph tokens)
- [ ] Consent failures return a structured MCP error with guidance
- [ ] The HTTP client attaches the token and calls the external API successfully

## Dependencies

- 1.2.2 (OBO token exchange) — existing OBO infrastructure
- 1.4.1 (external API project) — target API must exist
- 1.4.2 (app registration) — MCP server must have permission to call external API scopes

## Notes

The `DownstreamApis:MicrosoftGraph` config pattern already exists. This story adds a parallel `DownstreamApis:ExternalApi` entry. The `IDownstreamTokenProvider` interface may need a parameter to specify which downstream API's scopes to request.
