# 1.4: External Downstream API Service

**Status:** IN PROGRESS
**Epic:** [Epic 1: Project Foundation & Infrastructure](../_epic.md)
**Goal:** Create an independent downstream API (`LawCorp.Mcp.ExternalApi`) that the MCP server calls via On-Behalf-Of (OBO) token exchange, proving multi-hop identity delegation to a custom API with its own app registration, token validation, and authorization.
**ADR:** [ADR-005: OAuth identity passthrough](../../../decisions/005-oauth-identity-passthrough.md)
**Research:** [RESEARCH: App registration architecture](../1.2-authn/1.2.3-app-registrations-docs/RESEARCH-app-registration-architecture.md)
**Setup Guide:** [`docs/auth-config.md` — Step 11](../../../../docs/auth-config.md#step-11-configure-the-external-api)

## Context

The current architecture demonstrates OBO only to Microsoft Graph (a first-party Microsoft service). This feature adds a **custom downstream API** that the MCP server calls on behalf of the user, proving the enterprise pattern: MCP server as a facade over multiple backend APIs with user-delegated access.

See [BUG 1.2.3.1](../1.2-authn/1.2.3-app-registrations-docs/bugs/1.2.3.1-app-registration-architecture-mismatch.md) for the gap that prompted this feature.

## Items

| ID | Title | Type | Status |
|---|---|---|---|
| [1.4.1](./1.4.1-create-external-api-project.md) | Create `LawCorp.Mcp.ExternalApi` project with JWT Bearer auth | Story | DONE |
| [1.4.2](./1.4.2-external-api-app-registration.md) | Define app registration and `api://` scope for external API | Task | BACKLOG |
| [1.4.3](./1.4.3-document-api-endpoints.md) | Implement document API endpoints with OBO token validation | Story | DONE |
| [1.4.4](./1.4.4-mcp-server-obo-to-external-api.md) | MCP server OBO token exchange to external API | Story | IN PROGRESS |
| [1.4.5](./1.4.5-update-auth-config-docs.md) | Update `docs/auth-config.md` with third app registration | Task | BACKLOG |

## Acceptance Criteria

- [x] `LawCorp.Mcp.ExternalApi` project exists in the solution and runs independently on port 5002
- [ ] External API has its own Entra ID app registration with `api://` scopes (`data.read`, `data.write`)
- [x] External API validates OBO tokens from the MCP server and extracts user identity via `CallerIdentity`
- [x] External API enforces its own authorization based on FirmRole from claims and `DmsAccessRule` entity mapping
- [x] External API has its own database (`DmsDbContext` / `LawCorpDms`) with workspace-document-access schema
- [x] MCP server dispatches to handlers that acquire OBO tokens via `IDownstreamTokenProvider` and call external API
- [x] Document API endpoints return user-scoped data filtered by role-based workspace access rules
- [ ] `docs/auth-config.md` documents all three app registrations end-to-end
- [ ] Full stack (Web App + MCP Server + External API) runs locally with auth enabled

## Dependencies

- 1.2.1 (Entra ID auth middleware) — token validation patterns to reuse
- 1.2.2 (OBO token exchange) — `IDownstreamTokenProvider` must support multiple downstream APIs
- 1.5 (CQRS dispatch) — MCP tools dispatch to handlers that call the external API

## Port Allocation

| Service | Port |
|---|---|
| MCP Server | 5000 |
| Web App (HTTPS) | 5001 |
| External API | 5002 |
