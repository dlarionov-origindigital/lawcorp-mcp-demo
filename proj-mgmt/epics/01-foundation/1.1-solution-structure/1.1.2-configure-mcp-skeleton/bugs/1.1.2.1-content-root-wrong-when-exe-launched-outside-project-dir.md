# 1.1.2.1: Server crashes on startup when exe is launched outside the project directory

**Status:** DONE
**Type:** Bug
**Feature:** [1.1: Solution & Project Structure](../../1.1-solution-structure.md)
**Feature Item:** [1.1.2: Configure MCP server skeleton](../1.1.2-configure-mcp-skeleton.md)
**Related Epic:** [Epic 1: Foundation & Infrastructure](../../_epic.md)
**Tags:** `+foundation`, `+severity:high`, `+mcp-transport`, `+configuration`

---

## Problem

**Expected:** Running the compiled exe directly (e.g. from a chat agent, Cursor MCP config, Claude Desktop, or a bare PowerShell session) should start the MCP server regardless of the caller's working directory.

**Actual:** The server throws `System.InvalidOperationException: LawCorpDb connection string is missing` and terminates immediately. The connection string **is** present in the `appsettings.json` that ships alongside the exe in `bin/Debug/net9.0/`, but the configuration system never loads it.

**Reproduces:**

1. Build the solution (ensuring `appsettings.json` is copied to `bin/Debug/net9.0/`).
2. Open a terminal whose working directory is **not** `bin/Debug/net9.0/` — for example, the repo root `C:\Dev\research\mcp`.
3. Run:
   ```powershell
   powershell -Command "& 'C:\Dev\research\mcp\src\LawCorp.Mcp.Server\bin\Debug\net9.0\LawCorp.Mcp.Server.exe'"
   ```
4. Observe the `InvalidOperationException` on startup.
5. Repeat the same command but `cd` into `bin\Debug\net9.0\` first — the server starts correctly.

**Severity:** High

**Impact:** The server **cannot be used from any MCP client** (Claude Desktop, Cursor, VS Code Copilot) that launches the exe as a subprocess, because those clients set the working directory to their own location (or the workspace root), not to the exe's directory. This blocks all local MCP integration testing.

---

## Root Cause

`Host.CreateApplicationBuilder(args)` in `Program.cs` sets `ContentRootPath` to `Directory.GetCurrentDirectory()` — the **shell's working directory**, not the directory containing the exe. The configuration system then looks for `appsettings.json` relative to the content root, fails to find it, and the connection string resolves to `null`.

Visual Studio masks this because its launch profile sets the working directory to the project folder (`src/LawCorp.Mcp.Server/`), where the original `appsettings.json` lives. `dotnet run` also works because it sets the working directory to the project folder. But any other launch method (direct exe invocation, MCP client subprocess spawn, scheduled task, etc.) uses whatever working directory the caller has.

---

## Solution

### Changes Made

- `Program.cs`: Added `Directory.SetCurrentDirectory(AppContext.BaseDirectory);` as the **first line**, before `Host.CreateApplicationBuilder(args)`.

`AppContext.BaseDirectory` returns the directory containing the running assembly, regardless of the caller's working directory.

**Why `SetCurrentDirectory` instead of `SetBasePath`?** `Host.CreateApplicationBuilder()` adds appsettings sources during construction, using `Directory.GetCurrentDirectory()` as the base path. Calling `builder.Configuration.SetBasePath()` *after* construction is too late — the JSON sources were already resolved against the old CWD. Setting the CWD before the builder is created is the only approach that works without re-adding configuration sources manually.

---

## Investigation

### Research

- [x] Reproduce the bug (confirmed — fails from repo root, succeeds from bin dir)
- [x] Identify root cause (`ContentRootPath` defaults to `Directory.GetCurrentDirectory()`)
- [x] Verify the appsettings files are present in `bin/Debug/net9.0/` (confirmed via earlier `.csproj` fix)
- [x] Confirm fix works with `Directory.SetCurrentDirectory(AppContext.BaseDirectory)`
- [x] Confirmed `SetBasePath` after builder construction does NOT work (sources already resolved)

### Fix Steps

- [x] Add `Directory.SetCurrentDirectory(AppContext.BaseDirectory);` before `Host.CreateApplicationBuilder(args)` in `Program.cs`
- [x] Rebuild and verify: run the exe from the repo root — server starts successfully
- [x] Verify `dotnet run --no-launch-profile` still works

---

## Acceptance Criteria

- [x] `LawCorp.Mcp.Server.exe` starts successfully when launched from any working directory
- [x] `appsettings.json` and `appsettings.Development.json` are loaded from the exe's directory
- [x] `dotnet run --no-launch-profile` from any directory still works
- [ ] Visual Studio F5 debugging still works (to be verified manually)
- [ ] MCP client configs (Claude Desktop, Cursor, VS Code) can launch the exe without specifying a working directory (to be verified manually)

---

## Notes

- This bug was introduced implicitly when the server was created — it worked in VS because of the launch profile, but was never tested via direct exe invocation.
- The earlier fix to add `CopyToOutputDirectory` in the `.csproj` was a prerequisite — without it, the appsettings files weren't in the bin directory at all. That fix is necessary but not sufficient; this bug is the second half of the problem.
- When the dual-transport migration (ADR-004) moves to `WebApplication.CreateBuilder()`, the same issue will apply — `WebApplication` also defaults `ContentRootPath` to `Directory.GetCurrentDirectory()`. The fix should carry forward.
- Related: [ADR-004](../../../decisions/004-dual-transport-web-api-primary.md), [PLAN-dual-transport-implementation.md](../PLAN-dual-transport-implementation.md)
