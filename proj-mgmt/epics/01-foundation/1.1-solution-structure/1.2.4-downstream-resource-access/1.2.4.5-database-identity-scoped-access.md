# 1.2.4.5: Database access scoped by identity context

**Status:** IN PROGRESS
**Type:** Task
**Story:** [1.2.4: Downstream resource access](./1.2.4-downstream-resource-access.md)
**Tags:** `+auth` `+foundation`
**Setup Guide:** [`docs/auth-config.md`](../../../../docs/auth-config.md)

---

Verify and document that the local SQL Express database access path is fully driven by the user's identity extracted from the inbound Entra ID token, completing the "identity passthrough to all downstream resources" story.

## Context

Unlike Graph resources that require an OBO token exchange, the local database does not accept OAuth tokens directly. Instead, the server extracts identity claims from the validated JWT and uses `IFirmIdentityContext` (story 1.3.5) to drive the custom authorization layer (Feature 1.3):

- **Role-based access** (1.3.1): `IFirmIdentityContext.AttorneyRole` determines which operations are permitted
- **Row-level security** (1.3.2): EF Core global query filters use `IFirmIdentityContext.AssignedCaseIds` and `PracticeGroupId` to scope query results
- **Field-level redaction** (1.3.3): `IFirmIdentityContext.AttorneyRole` determines whether privileged fields are redacted
- **Audit logging** (1.3.4): `IFirmIdentityContext.UserId` is recorded on every data access

This task ensures these layers compose correctly and that the end-to-end path from "Bearer token → claim extraction → identity context → filtered database query" works as a unified pipeline.

## Implementation Steps

- [ ] Create an integration test that sends an HTTP request with a persona's identity, invokes a case-search tool, and asserts the results are filtered to that persona's access scope
- [ ] Create an integration test for each persona role verifying row-level filtering (Partner sees practice group cases, Associate sees assigned cases, Intern sees assigned + redacted)
- [ ] Verify that `IFirmIdentityContext` is populated from JWT claims in production and from `FakeIdentityContext` in tests — same authorization code path, different identity source
- [ ] Document the identity flow diagram: Token → Middleware → Claims → IFirmIdentityContext → EF Core Filters → SQL query

## Acceptance Criteria

- [ ] The same authorization handler code executes regardless of whether the identity comes from a real Entra token or `FakeIdentityContext`
- [ ] Each persona in the fixture (7.2) produces the correct filtered result set when querying cases, documents, and billing data
- [ ] The audit log records the correct user identity for each data access
- [ ] No database query executes without an `IFirmIdentityContext` in scope (enforced by a middleware guard or DI validation)

## Dependencies

- 1.3.1–1.3.5 (custom authorization layer) — all auth handlers must be implemented
- 7.1.2 (`FakeIdentityContext`) — test double must be available for integration tests
- 7.2 (persona fixture) — test data must be seeded

## Notes

This task is primarily a verification and documentation task — the implementation work lives in Feature 1.3. Its purpose is to close the loop on the "identity passthrough" story by proving that local database access follows the same user-identity-driven pattern as Graph access.
