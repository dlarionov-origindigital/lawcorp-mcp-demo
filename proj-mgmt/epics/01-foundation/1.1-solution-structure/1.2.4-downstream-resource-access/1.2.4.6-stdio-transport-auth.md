# 1.2.4.6: Authentication support for stdio transport

**Status:** BACKLOG
**Type:** Task
**Story:** [1.2.4: Downstream resource access via identity passthrough](./1.2.4-downstream-resource-access.md)
**Tags:** `+auth` `+transport` `+future`

---

## Context

Currently, Entra ID authentication only works on the HTTP transport (`Transport=http`) because JWT Bearer tokens arrive as HTTP headers. The stdio transport (`Transport=stdio`) falls back to `AnonymousUserContext` even when `UseAuth=true`, with a console warning.

MCP clients that launch the server as a subprocess (Claude Desktop, VS Code, Claude Code) use stdio. To enable identity-scoped access in these clients, we need an auth mechanism that works without HTTP headers.

## Potential Approaches

| Approach | Mechanism | Pros | Cons |
|---|---|---|---|
| **Init-param token** | Client passes a Bearer token in the `initialize` request params | Standard MCP flow; works with any MCP client that supports auth params | Requires MCP SDK support for init-time auth; token refresh lifecycle |
| **Environment variable** | Token passed as `MCP_AUTH_TOKEN` env var at process spawn | Simple; no protocol changes | Token is static for the process lifetime; visible in process list |
| **Named pipe / sidecar** | Auth sidecar provides tokens via IPC | Decoupled; supports token refresh | Complex; additional process to manage |
| **MCP protocol auth extension** | Wait for the MCP spec to standardize stdio auth | Standards-compliant | Timeline uncertain |

## Acceptance Criteria

- [ ] When `Transport=stdio` and `UseAuth=true`, the server authenticates the caller without HTTP headers
- [ ] `IUserContext` and `IFirmIdentityContext` are populated from the authenticated identity (same as HTTP path)
- [ ] The same persona test matrix passes on both transports
- [ ] Claude Desktop and VS Code can connect with user identity

## Dependencies

- 1.2.4 (HTTP auth must be working first — this is the follow-on)
- MCP specification may need to standardize an auth mechanism for stdio

## References

- [MCP specification — Transports](https://modelcontextprotocol.io/docs/concepts/transports)
- [ServerBootstrap.RunStdioAsync](../../../../src/LawCorp.Mcp.Server/ServerBootstrap.cs) — current fallback logic
