# BUG: AuthorizationPolicyCache fails to resolve EndpointDataSource on Generic Host

**Status:** RESOLVED
**Type:** Bug
**Severity:** Blocker (prevents `UseAuth=true` from starting)
**Story:** [1.2.4: Downstream resource access via identity passthrough](./1.2.4-downstream-resource-access.md)
**Discovered:** 2026-02-24

---

## Symptom

When `UseAuth=true` in `appsettings.Development.json`, the server crashes immediately on startup:

```
System.AggregateException: Some services are not able to be constructed
  (Error while validating the service descriptor
   'ServiceType: Microsoft.AspNetCore.Authorization.Policy.AuthorizationPolicyCache
    Lifetime: Singleton
    ImplementationType: Microsoft.AspNetCore.Authorization.Policy.AuthorizationPolicyCache':
    Unable to resolve service for type 'Microsoft.AspNetCore.Routing.EndpointDataSource'
    while attempting to activate 'Microsoft.AspNetCore.Authorization.Policy.AuthorizationPolicyCache'.)
```

The crash occurs at `builder.Build()` (`Program.cs:56`), before any HTTP request is ever processed.

## Root Cause

`Program.cs` uses `Host.CreateApplicationBuilder(args)` which creates a **Generic Host** — a console-app host that does not register ASP.NET Core web infrastructure (routing, endpoints, Kestrel).

`AuthServiceCollectionExtensions.AddEntraIdAuthentication()` calls:

```csharp
services.AddAuthorization();   // line 31
```

In .NET 9, `AddAuthorization()` registers `AuthorizationPolicyCache`, which has a constructor dependency on `Microsoft.AspNetCore.Routing.EndpointDataSource`. That service is **only** registered by ASP.NET Core's `WebApplication.CreateBuilder()` (or by explicitly calling `services.AddRouting()`).

The Generic Host knows nothing about routing, so the DI container validation fails.

### Why it compiled but didn't run

The project references `<FrameworkReference Include="Microsoft.AspNetCore.App" />`, which makes the ASP.NET Core types available at **compile time**. However, at runtime the Generic Host never registers the web-specific services those types depend on. The mismatch between "types are visible" and "services are registered" is the core of this bug.

### Contributing factor

The auth implementation (story 1.2.4) was built ahead of the transport migration. The `local-mcp-inspect-auth.md` guide documents that switching to `WebApplication.CreateBuilder` + HTTP transport is a **prerequisite** for auth, but `Program.cs` was left on the Generic Host path even when `UseAuth=true`.

## Impact

- **`UseAuth=false`**: Unaffected. The `AnonymousUserContext` path never calls `AddAuthorization()`.
- **`UseAuth=true`**: 100% startup crash. No workaround short of code change.

## Fix Plan

See [`1.2.4-fix-plan-web-host-migration.md`](./1.2.4-fix-plan-web-host-migration.md) for the proposed fix with options and trade-off analysis.

## Reproduction

```bash
# In appsettings.Development.json, ensure:
#   "UseAuth": true
dotnet run --project src/LawCorp.Mcp.Server
# → Immediate crash with AggregateException
```

## Affected Files

| File | Role |
|---|---|
| `src/LawCorp.Mcp.Server/Program.cs` | Uses `Host.CreateApplicationBuilder` — root cause |
| `src/LawCorp.Mcp.Server/Auth/AuthServiceCollectionExtensions.cs` | Calls `AddAuthorization()` which triggers the missing dependency |
| `src/LawCorp.Mcp.Server/LawCorp.Mcp.Server.csproj` | Uses `Microsoft.NET.Sdk` (not `Microsoft.NET.Sdk.Web`) |
