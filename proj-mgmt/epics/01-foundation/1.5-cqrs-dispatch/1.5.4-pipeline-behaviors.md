# 1.5.4: Implement pipeline behaviors (authorization, audit, validation)

**Status:** BACKLOG
**Type:** Story
**Feature:** [1.5: CQRS Dispatch Pattern for MCP Tools](./1.5-cqrs-dispatch.md)
**Tags:** `+architecture`, `+cqrs`, `+auth`

---

As a platform team member,
I want cross-cutting concerns applied automatically to every command/query dispatch,
So that authorization, audit logging, and validation are consistent without duplicating code in each handler.

- [ ] Implement `AuthorizationBehavior<TRequest, TResponse> : IPipelineBehavior` — checks that the user's role permits the dispatched action (supplements `ToolPermissionFilters`)
- [ ] Implement `AuditLoggingBehavior<TRequest, TResponse> : IPipelineBehavior` — logs every dispatch with user context, request type, and timing (feeds into story 1.3.4)
- [ ] Implement `ValidationBehavior<TRequest, TResponse> : IPipelineBehavior` — validates request parameters using FluentValidation (or manual checks) before reaching the handler
- [ ] Register behaviors in DI in the correct order: Validation → Authorization → Audit → Handler
- [ ] Add at least one FluentValidation validator (e.g., `SearchCasesQueryValidator`)

## Acceptance Criteria

- [ ] Authorization behavior prevents unauthorized dispatches (returns structured error)
- [ ] Audit behavior logs user ID, request type, timestamp, and duration for every dispatch
- [ ] Validation behavior rejects invalid requests before they reach the handler
- [ ] Behaviors are registered and execute in the correct order
- [ ] Behaviors are unit-testable with fake identity contexts

## Dependencies

- 1.5.1 (MediatR contracts)
- 1.5.2 (handlers project)
- 1.3.4 (audit logging) — the audit behavior feeds into the audit log infrastructure

## Notes

The authorization behavior is a defense-in-depth layer. The primary tool-level authorization is still handled by `ToolPermissionFilters` at the MCP protocol boundary. The MediatR behavior catches cases where a handler is dispatched from a context other than a tool call (e.g., future internal dispatches).
