# 1.5.5: Implement external API handler (dispatches OBO HTTP call)

**Status:** DONE
**Type:** Story
**Feature:** [1.5: CQRS Dispatch Pattern for MCP Tools](./1.5-cqrs-dispatch.md)
**Tags:** `+architecture`, `+cqrs`, `+auth`, `+obo`

---

As the MCP server processing a document search tool call,
I want the MediatR handler to acquire an OBO token and call the external API,
So that document data is retrieved under the user's delegated identity without the tool knowing about the external API.

- [x] Implement `SearchDocumentsHandler : IRequestHandler<SearchDocumentsQuery, SearchDocumentsResult>` — acquires OBO token for external API, calls `GET /api/documents?query=...`
- [x] Implement `GetDocumentByIdHandler : IRequestHandler<GetDocumentByIdQuery, GetDocumentResult>` — acquires OBO token, calls `GET /api/documents/{id}`
- [x] Implement `ListDocumentsByCaseHandler : IRequestHandler<ListDocumentsByCaseQuery, SearchDocumentsResult>` — acquires OBO token, calls `GET /api/documents?caseId=...`
- [x] Inject `IDownstreamTokenProvider` and named `HttpClient` ("ExternalApi") for the external API
- [x] Map external API JSON responses to shared result types from `LawCorp.Mcp.Core.Queries`
- [x] Handle HTTP errors from the external API (401→exception, 403→structured error, 404→null result)

## Acceptance Criteria

- [x] `SearchDocumentsHandler` calls the external API and returns document results
- [x] `GetDocumentByIdHandler` calls the external API and returns single document details
- [x] `ListDocumentsByCaseHandler` calls the external API filtered by case
- [x] OBO token is acquired per-request via `IDownstreamTokenProvider`
- [x] The tool dispatching queries does not know the data comes from an external API
- [x] 403 from the external API is surfaced as a structured error; 401 raises `UnauthorizedAccessException`
- [ ] Token caching prevents redundant OBO exchanges within the same request scope (depends on MSAL cache config)

## Dependencies

- 1.4.3 (document API endpoints) — the external API must have endpoints to call
- 1.4.4 (MCP server OBO to external API) — OBO token exchange must be configured
- 1.5.1 (MediatR contracts) — `SearchDocumentsQuery` and `CreateDocumentCommand` must be defined
- 1.5.2 (handlers project) — handler lives in the handlers project
