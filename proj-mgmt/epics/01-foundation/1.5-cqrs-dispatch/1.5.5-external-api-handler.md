# 1.5.5: Implement external API handler (dispatches OBO HTTP call)

**Status:** BACKLOG
**Type:** Story
**Feature:** [1.5: CQRS Dispatch Pattern for MCP Tools](./1.5-cqrs-dispatch.md)
**Tags:** `+architecture`, `+cqrs`, `+auth`, `+obo`

---

As the MCP server processing a document search tool call,
I want the MediatR handler to acquire an OBO token and call the external API,
So that document data is retrieved under the user's delegated identity without the tool knowing about the external API.

- [ ] Implement `SearchDocumentsHandler : IRequestHandler<SearchDocumentsQuery, SearchDocumentsResult>` — acquires OBO token for external API, calls `GET /api/documents?caseId=...`
- [ ] Implement `CreateDocumentHandler : IRequestHandler<CreateDocumentCommand, CreateDocumentResult>` — acquires OBO token with `data.write` scope, calls `POST /api/documents`
- [ ] Inject `IDownstreamTokenProvider` and typed/named `HttpClient` for the external API
- [ ] Map external API JSON responses to `SearchDocumentsResult` / `CreateDocumentResult`
- [ ] Handle HTTP errors from the external API (401, 403, 500) with structured MCP error responses

## Acceptance Criteria

- [ ] `SearchDocumentsHandler` calls the external API and returns document results
- [ ] `CreateDocumentHandler` calls the external API with `data.write` scope
- [ ] OBO token is acquired per-request via `IDownstreamTokenProvider`
- [ ] The tool dispatching `SearchDocumentsQuery` does not know the data comes from an external API
- [ ] 401/403 from the external API is surfaced as a structured MCP error (not unhandled exception)
- [ ] Token caching prevents redundant OBO exchanges within the same request scope

## Dependencies

- 1.4.3 (document API endpoints) — the external API must have endpoints to call
- 1.4.4 (MCP server OBO to external API) — OBO token exchange must be configured
- 1.5.1 (MediatR contracts) — `SearchDocumentsQuery` and `CreateDocumentCommand` must be defined
- 1.5.2 (handlers project) — handler lives in the handlers project
