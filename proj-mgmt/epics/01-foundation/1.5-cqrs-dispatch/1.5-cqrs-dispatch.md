# 1.5: CQRS Dispatch Pattern for MCP Tools

**Status:** IN PROGRESS
**Epic:** [Epic 1: Project Foundation & Infrastructure](../_epic.md)
**Goal:** Introduce a MediatR-based CQRS dispatch layer so MCP tools are thin dispatchers that construct commands/queries, while handlers determine how to fulfill requests — whether from a local database, an external API via OBO, or Microsoft Graph.
**ADR:** [ADR-008: CQRS dispatch pattern](../../../decisions/008-cqrs-dispatch-pattern.md)
**Research:** [RESEARCH: App registration architecture](../1.2-authn/1.2.3-app-registrations-docs/RESEARCH-app-registration-architecture.md)

## Context

MCP tools currently inject `DbContext` directly and execute queries inline. This couples tools to the local database and prevents dispatching to external APIs. With the addition of `LawCorp.Mcp.ExternalApi` (Feature 1.4), some tools need to call an external API via OBO while others query the local database. MediatR provides a clean separation: tools dispatch; handlers resolve the data source.

## Items

| ID | Title | Type | Status |
|---|---|---|---|
| [1.5.1](./1.5.1-mediatr-contracts.md) | Add MediatR and define command/query contracts | Story | DONE |
| [1.5.2](./1.5.2-handlers-project.md) | Create `LawCorp.Mcp.Server.Handlers` project | Story | DONE |
| [1.5.3](./1.5.3-refactor-tools-to-dispatch.md) | Refactor existing tools to dispatch via `IMediator` | Story | DONE |
| [1.5.4](./1.5.4-pipeline-behaviors.md) | Implement pipeline behaviors (authorization, audit, validation) | Story | BACKLOG |
| [1.5.5](./1.5.5-external-api-handler.md) | Implement external API handler (dispatches OBO HTTP call) | Story | DONE |

## Acceptance Criteria

- [x] MediatR is registered in the MCP server's DI container
- [x] Command/query contracts are defined in `LawCorp.Mcp.Core`
- [x] At least one tool (e.g., case search) dispatches via `IMediator` instead of direct DbContext
- [x] A handler exists that queries the local database (proving the local path works through MediatR)
- [x] A handler exists that calls the external API via OBO (proving the external path works through MediatR)
- [ ] Pipeline behaviors for authorization and audit logging are functional
- [x] Tools do not directly reference `DbContext` or `HttpClient` — they only reference `IMediator`

## Dependencies

- 1.2.2 (OBO token exchange) — handlers that call external APIs need `IDownstreamTokenProvider`
- 1.4 (External API) — the external API handler needs a target API to call
