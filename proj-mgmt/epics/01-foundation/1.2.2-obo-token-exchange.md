# 1.2.2: Implement On-Behalf-Of (OBO) token exchange

**Status:** BACKLOG
**Type:** Story
**Feature:** [1.2: Authentication — Microsoft Entra ID](./1.2-authentication.md)
**Tags:** `+auth`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)

---

As a Law-Corp attorney using an AI assistant,
I want my identity to flow through to downstream services,
So that I only see data I'm authorized to see.

This story implements the OBO token exchange infrastructure that [ADR-005](../../decisions/005-oauth-identity-passthrough.md) identifies as the mechanism for accessing Microsoft Graph resources (SharePoint, Outlook Calendar, Mail) under the calling user's delegated identity. The downstream resource integrations that consume this infrastructure are defined in [story 1.2.4](./1.2.4-downstream-resource-access/1.2.4-downstream-resource-access.md).

- [ ] Configure `IConfidentialClientApplication` (MSAL) with the MCP server's Entra app registration credentials
- [ ] Implement OBO flow using `AcquireTokenOnBehalfOf()` to exchange the inbound user token for a downstream-scoped token
- [ ] Implement token caching strategy — MSAL's in-memory cache for dev, distributed cache (Redis or SQL) for production
- [ ] Add error handling for consent/authorization failures — catch `MsalUiRequiredException` and surface as a structured response (see [1.2.4.4](./1.2.4-downstream-resource-access/1.2.4.4-consent-flow-handling.md))

## Acceptance Criteria

- [ ] Caller identity propagates to downstream services via OBO token
- [ ] OBO tokens are cached to avoid unnecessary round-trips
- [ ] Consent and authorization failures are handled gracefully
- [ ] The OBO exchange uses scoped DI so each HTTP request exchanges the correct user's token

## Notes

Depends on 1.2.1 (Entra ID auth middleware) being complete.
Consumed by [1.2.4.1](./1.2.4-downstream-resource-access/1.2.4.1-graph-client-obo-provider.md) (Graph client with OBO provider).
