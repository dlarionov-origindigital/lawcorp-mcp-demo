# 1.2.2: Implement On-Behalf-Of (OBO) token exchange

**Status:** IN PROGRESS
**Type:** Story
**Feature:** [1.2: Authentication — Microsoft Entra ID](./1.2-authentication.md)
**Tags:** `+auth`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)
**Setup Guide:** [`docs/auth-config.md`](../../../docs/auth-config.md)

---

As a Law-Corp attorney using an AI assistant,
I want my identity to flow through to downstream services,
So that I only see data I'm authorized to see.

This story implements the OBO token exchange infrastructure that [ADR-005](../../decisions/005-oauth-identity-passthrough.md) identifies as the mechanism for accessing Microsoft Graph resources (SharePoint, Outlook Calendar, Mail) under the calling user's delegated identity. The downstream resource integrations that consume this infrastructure are defined in [story 1.2.4](./1.2.4-downstream-resource-access/1.2.4-downstream-resource-access.md).

- [x] Configure confidential client credentials — `Microsoft.Identity.Web` v4.3.0 reads `AzureAd:ClientSecret` (or `ClientCertificates`) from `appsettings.json`
- [x] Implement OBO flow — `OboDownstreamTokenProvider` uses `ITokenAcquisition.GetAccessTokenForUserAsync()` which performs OBO exchange internally
- [x] Implement token caching strategy — `AddInMemoryTokenCaches()` for dev; distributed cache for production is a follow-up
- [x] Add error handling for consent/authorization failures — `OboDownstreamTokenProvider` catches `MicrosoftIdentityWebChallengeUserException` and wraps it in a descriptive error

## Acceptance Criteria

- [x] Caller identity propagates to downstream services via OBO token — `OboDownstreamTokenProvider` registered as scoped `IDownstreamTokenProvider`
- [x] OBO tokens are cached to avoid unnecessary round-trips — `AddInMemoryTokenCaches()` configured
- [x] Consent and authorization failures are handled gracefully — consent errors caught and re-thrown with guidance
- [x] The OBO exchange uses scoped DI so each HTTP request exchanges the correct user's token — `IDownstreamTokenProvider` registered as `Scoped`

## Notes

Depends on 1.2.1 (Entra ID auth middleware) being complete.
Consumed by [1.2.4.1](./1.2.4-downstream-resource-access/1.2.4.1-graph-client-obo-provider.md) (Graph client with OBO provider).
