# 1.3.5: Define `IFirmIdentityContext` abstraction

**Status:** IN PROGRESS
**Type:** Task
**Feature:** [1.3: Custom Authorization Layer](./1.3-authorization.md)
**Tags:** `+auth` `+foundation`
**ADR:** [ADR-005: OAuth identity passthrough](../../decisions/005-oauth-identity-passthrough.md)
**Setup Guide:** [`docs/auth-config.md`](../../../docs/auth-config.md)

---

Define the `IFirmIdentityContext` interface that the authorization layer reads user identity from, and provide the production implementation that resolves claims from the validated Entra ID JWT. This abstraction is the linchpin of the identity passthrough architecture ([ADR-005](../../decisions/005-oauth-identity-passthrough.md)) — it makes the authorization layer testable without real Entra tokens and ensures the same identity model drives access to both Graph resources (via OBO) and local database records (via EF Core filters).

## Why this exists

The ASP.NET Core auth middleware validates the JWT, but the MCP tool handlers and authorization handlers need a typed, domain-aware identity object — not raw claim strings. If handlers read directly from `HttpContext.User`, they are untestable without a real HTTP pipeline and real tokens.

`IFirmIdentityContext` provides:
- The current user's `UserId` (mapped from Entra Object ID claim)
- Their `AttorneyRole` or staff role
- Their `PracticeGroupId`
- Their list of assigned case IDs (for row-level filtering)
- Their `AssignedAttorneyId` (for LegalAssistant / Intern)
- A convenience method `HasRole(AttorneyRole)` and `IsInPracticeGroup(int)`

See [ADR-004](../../decisions/004-dual-transport-web-api-primary.md) for the full rationale.

## Implementation Steps

- [x] Define `IFirmIdentityContext` interface in `LawCorp.Mcp.Core` — `src/LawCorp.Mcp.Core/Auth/IFirmIdentityContext.cs`
- [x] Implement `EntraFirmIdentityContext : IFirmIdentityContext` in `LawCorp.Mcp.Server` — `src/LawCorp.Mcp.Server/Auth/EntraFirmIdentityContext.cs`; resolved by `UserContextResolutionMiddleware` from JWT claims + database
- [x] Register `IFirmIdentityContext` → `EntraFirmIdentityContext` as a **scoped** service via `AuthServiceCollectionExtensions.AddEntraIdAuthentication()` (reads from `HttpContext.Items`)
- [ ] Update `1.3.1` authorization handler to take `IFirmIdentityContext` as a constructor dependency instead of reading raw claims
- [ ] Update `1.3.2` EF Core global query filters to receive the identity context via a scoped factory rather than reading `IHttpContextAccessor` directly

## Acceptance Criteria

- [x] `IFirmIdentityContext` is defined in `LawCorp.Mcp.Core` with no dependency on ASP.NET Core packages
- [x] `EntraFirmIdentityContext` resolves the attorney from the database by `oid` claim → `Attorney.EntraObjectId`, inheriting the `AttorneyRole` from the database record
- [ ] Authorization handlers compile and pass their unit tests using a `FakeIdentityContext` double (the double lives in the test project, not here)
- [x] DI registration is scoped — each request gets its own resolved identity via `HttpContext.Items`

## Notes

This task is a prerequisite for Epic 7 feature 7.1.2 (`FakeIdentityContext` test double).
